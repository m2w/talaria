var talaria=function(t){"use strict";function a(t){return t.replace(/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-_\.]+)$/,v.COMMENTABLE_CONTENT_PATH_PREFIX+"$1-$2-$3-$4"+v.CONTENT_SUFFIX)}function e(t){return t.substr(0,7)}function n(){try{return sessionStorage.setItem("dummy","dummy"),sessionStorage.removeItem("dummy"),!0}catch(t){return!1}}function r(t,a){return new Date(t.updated_at)>new Date(a.updated_at)}function i(t,a){function e(t){return 1===t?"":"s"}var n=6e4,r=60*n,i=24*r,o=30*i,s=365*i,m=15e3,c=t-a,d=0;return n>c?m>c?" just now":Math.round(c/1e3)+" seconds ago":r>c?(d=Math.round(c/n),d+" minute"+e(d)+" ago"):i>c?(d=Math.round(c/r),d+" hour"+e(d)+" ago"):o>c?(d=Math.round(c/i),d+" day"+e(d)+" ago"):s>c?(d=Math.round(c/o),"about "+d+" month"+e(d)+" ago"):(d=Math.round(c/s),"about "+d+" year"+e(d)+" ago")}function o(t){return(new Date).getTime()-t.timestamp>v.CACHE_TIMEOUT}function s(t){var a=sessionStorage.getItem(t);return a&&(a=JSON.parse(a),!o(a))?a.comment_data:void 0}function m(t,a,e,n){return'<div id="talaria-wrap-'+t+'" class="talaria-wrapper">  <div class="talaria-load-error hide">    Unable to retrieve comments for this post.  </div>  <div class="talaria-comment-count'+(n?"":" hide")+'">    <a id="talaria-show-'+t+'" href="'+a+'">'+(0===e?"Be the first to comment":e+" comment"+(1===e?"":"s"))+'</a>  </div>  <div class="talaria-comment-list-wrapper'+(n?" hide":"")+'">    <div class="talaria-header">      <h3>Comments <small>via <a class="talaria-last-commit-href" href="'+a+'">github</a></small></h3>    </div>    <div class="talaria-comment-list">      <!-- comments are dynamically added here -->    </div>    <div class="talaria-align-right">      <a id="talaria-add-'+t+'" class="talaria-add-comment-button" href="'+a+'">        <button type="submit">Add a Comment</button>      </a>    </div>  </div></div>'}function c(t){var a=(new Date).getTime();return'<div id="'+t.id+'" class="talaria-comment-bubble">  <a href="#">    <img class="talaria-comment-author-avatar" height="48" width="48" src="'+t.user.avatar_url+'" />  </a>  <div class="talaria-comment-bubble-content">    <div class="talaria-comment-bubble-inner">      <div class="talaria-comment-header">        <a class="talaria-author-nick" href="'+t.user.html_url+'"><b>'+t.user.login+'</b></a>        <span class="talaria-header-left">&nbsp;commented on <a class="talaria-commit-sha" href="'+t.html_url+'"><code>'+e(t.commit_id)+'</code></a></span>        <span class="talaria-header-right">'+i(a,new Date(t.updated_at))+'</span>      </div>      <div class="talaria-comment-body">'+t.body_html+"</div>    </div>  </div></div>"}function d(a,e){var n=new t.Deferred;return t.getJSON(v.COMMIT_API_ENDPOINT+"/"+a.sha+"/comments").then(function(t){n.resolve({commits:a,comments:t,path:e})},function(t){n.reject(t.status)}),n}function l(a,e){var n=new t.Deferred,r=e.map(function(t){return d(t,a)});return t.when.apply(t,r).done(function(){var t,e=Array.prototype.slice.call(arguments,0);e&&e.length&&(t={path:a,commits:[],comments:[]},e=e.reduce(function(t,a){return t.commits=t.commits.concat(a.commits),t.comments=t.comments.concat(a.comments),t},t)),n.resolve(e)}),n}function u(a){var e=new t.Deferred;return t.getJSON(v.COMMIT_API_ENDPOINT,{path:a}).then(function(t){l(a,t).done(function(t){e.resolve(t)})},function(t){e.reject(t.status)}),e}function h(e){var n,r=a(e);if(v.LOCAL_STORAGE_SUPPORTED){if(n=s(e)){var i=new t.Deferred;return i.resolve(n),i}return u(r)}return u(r)}function f(a,e){var n,r,i;r=e.commits.length?e.commits.sort(function(t,a){return new Date(t.commit.author.date)<new Date(a.commit.author.date)})[0]:e.commits,i=v.REPO_COMMIT_URL_ROOT+r.sha+"#all_commit_comments",n=m(r.sha,i,e.comments.length,"/"===location.pathname||v.PAGINATION_SCHEME.test(location.pathname)),a.parents("article").append(n),t("a#talaria-show-"+r.sha).click(function(a){a.preventDefault(),t("div#talaria-wrap-"+r.sha+" .talaria-comment-list-wrapper").fadeIn(),t(this).hide()}),t("a#talaria-add-"+r.sha).click(function(){v.LOCAL_STORAGE_SUPPORTED&&sessionStorage.removeItem(a.get(0).href)})}var v={},p={COMMENTABLE_CONTENT_PATH_PREFIX:"_posts/",CONTENT_SUFFIX:".md",CACHE_TIMEOUT:36e5,PAGINATION_SCHEME:/\/page\d+\//,LOCAL_STORAGE_SUPPORTED:!1,PERMALINK_IDENTIFIER:"a.permalink"},_=function(a){v=t.extend({},p,a),v.COMMIT_API_ENDPOINT="https://api.github.com/repos/"+v.GITHUB_USERNAME+"/"+v.REPOSITORY_NAME+"/commits",v.REPO_COMMIT_URL_ROOT="https://github.com/"+v.GITHUB_USERNAME+"/"+v.REPOSITORY_NAME+"/commit/",t(document).ready(function(){n&&(v.LOCAL_STORAGE_SUPPORTED=!0),t.ajaxSetup({accepts:{json:"application/vnd.github.v3.html+json"}}),t(v.PERMALINK_IDENTIFIER).map(function(){var a=this;t.when(h(a.href)).then(function(e){if(t.isEmptyObject(e)){var n=t(a).parents("article");n.find("div.talaria-load-error").show(),n.find("div.talaria-comment-count").hide()}else{var i=e.comments.sort(r).map(c);f(t(a),e),t(a).parents("article").find("div.talaria-comment-list").prepend(i),v.LOCAL_STORAGE_SUPPORTED&&sessionStorage.setItem(a.href,JSON.stringify({timestamp:(new Date).getTime(),comment_data:e}))}},function(){var e=t(a).parents("article");e.find("div.talaria-load-error").text("The github API rate-limit has been reached. Unable to load comments.").show(),e.find("div.talaria-comment-count").hide()})})})},E=function(a){t.get(a)};return{init:_,ping:E}}($);