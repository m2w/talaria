var talaria=function(a,t){"use strict";function e(){switch(P.PERMALINK_STYLE){case"pretty":return/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)\/$/;case"date":return/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)\.html$/;case"none":if(!P.USE_GISTS)throw new Error("When using commit-based comments, talaria requires the use of permalinks that include the date of the post");return/[\.\w\-_:\/]+\/([\w\-\.]+)\.html$/;default:return P.PERMALINK_STYLE}}function i(a){return a.replace(P.PERMALINK_STYLE,P.COMMENTABLE_CONTENT_PATH_PREFIX+"$1-$2-$3-$4"+P.CONTENT_SUFFIX)}function n(a){return a.substr(0,7)}function r(){try{return sessionStorage.setItem("dummy","dummy"),sessionStorage.removeItem("dummy"),!0}catch(a){return!1}}function o(a,t){P.LOCAL_STORAGE_SUPPORTED&&sessionStorage.setItem(a,JSON.stringify({timestamp:(new Date).getTime(),commentData:t}))}function s(a,t){return new Date(a.updated_at)>new Date(t.updated_at)}function c(a,t){function e(a){return 1===a?"":"s"}var i=6e4,n=60*i,r=24*n,o=30*r,s=365*r,c=15e3,m=a-t,l=0;return i>m?c>m?" just now":Math.round(m/1e3)+" seconds ago":n>m?(l=Math.round(m/i),l+" minute"+e(l)+" ago"):r>m?(l=Math.round(m/n),l+" hour"+e(l)+" ago"):o>m?(l=Math.round(m/r),l+" day"+e(l)+" ago"):s>m?(l=Math.round(m/o),"about "+l+" month"+e(l)+" ago"):(l=Math.round(m/s),"about "+l+" year"+e(l)+" ago")}function m(a){return(new Date).getTime()-a.timestamp>P.CACHE_TIMEOUT}function l(a){var t;return P.LOCAL_STORAGE_SUPPORTED&&(t=sessionStorage.getItem(a),t&&(t=JSON.parse(t),!m(t)))?t.commentData:void 0}function d(a){return a.length>0?a.sort(function(a,t){return new Date(a.committer.date)>new Date(t.committer.date)})[0]:void 0}function u(){if(P.USE_GISTS&&t==={})throw new Error("talaria requires async.js for Gist-based comments.")}function h(t){P=a.extend({},M,t),P.GISTS_API_ENDPOINT="https://api.github.com/users/"+P.GITHUB_USERNAME+"/gists",P.COMMIT_API_ENDPOINT="https://api.github.com/repos/"+P.GITHUB_USERNAME+"/"+P.REPOSITORY_NAME+"/commits",P.REPO_COMMIT_URL_ROOT="https://github.com/"+P.GITHUB_USERNAME+"/"+P.REPOSITORY_NAME+"/commit/",P.GIST_URL_ROOT="https://gist.github.com/"+P.GITHUB_USERNAME+"/",P.PERMALINK_STYLE=e()}function p(a,t,e,i){return i=0===e||i,'<div id="talaria-wrap-'+a+'" class="talaria-wrapper">  <div class="talaria-load-error hide">    Unable to retrieve comments for this post.  </div>  <div class="talaria-comment-count'+(i?"":" hide")+'">    <a id="talaria-show-'+a+'" href="'+t+'">'+(0===e?"Be the first to comment":e+" comment"+(1===e?"":"s"))+'</a>  </div>  <div class="talaria-comment-list-wrapper'+(i?" hide":"")+'">    <div class="talaria-header">      <h3>Comments <small>via <a class="talaria-last-commit-href" href="'+t+'">github</a></small></h3>    </div>    <div class="talaria-comment-list" id="talaria-comment-list-'+a+'">      <!-- comments are dynamically added here -->    </div>    <div class="talaria-align-right">      <a id="talaria-add-'+a+'" class="talaria-add-comment-button" href="'+t+'">        <button type="submit">Add a Comment</button>      </a>    </div>  </div></div>'}function f(a){var t,e=(new Date).getTime();return t=void 0!==a.commit_id?'<span class="talaria-header-left">&nbsp;commented on <a class="talaria-commit-sha" href="'+a.html_url+'"><code>'+n(a.commit_id)+"</code></a></span>":'<span class="talaria-header-left">&nbsp;wrote</span>','<div id="'+a.id+'" class="talaria-comment-bubble">  <a href="#">    <img class="talaria-comment-author-avatar" height="48" width="48" src="'+a.user.avatar_url+'" />  </a>  <div class="talaria-comment-bubble-content">    <div class="talaria-comment-bubble-inner">      <div class="talaria-comment-header">        <a class="talaria-author-nick" href="'+a.user.html_url+'"><b>'+a.user.login+"</b></a>"+t+'        <span class="talaria-header-right">'+c(e,new Date(a.updated_at))+'</span>      </div>      <div class="talaria-comment-body">'+a.body_html||a.body+"</div>    </div>  </div></div>"}function _(t,e){a.getJSON(P.COMMIT_API_ENDPOINT,{path:t}).then(function(a){e(null,a)},function(a){e(a)})}function E(t,e,i){e.commit.comment_count>0?a.getJSON(P.COMMIT_API_ENDPOINT+"/"+e.sha+"/comments").then(function(a){i(null,t.concat(a))},function(a){i(a,t)}):i(null,t)}function v(a,e){t.reduce(a,[],E,function(t,i){i.sort(s),e(t,a,i)})}function T(a,e){var n=a.href,r=i(n),s=l(n);void 0===s?t.waterfall([function(a){_(r,a)},function(a,t){v(a,t)}],function(t,i,r){if(t)e(t);else{var s={comments:r,commits:i};o(n,s),I(a,s),e(null)}}):(I(a,s),e(null))}function I(t,e){var i=e.commits,n=e.comments;if(0===i.length){var r=p("","",0,!1),o=a(t).parents("article");o.append(r),o.find("div.talaria-load-error").text("Unable to find commits for this post.").removeClass("hide"),o.find("div.talaria-comment-count").addClass("hide")}else{var s=d(i),c=P.REPO_COMMIT_URL_ROOT+s.sha+"#all_commit_comments",r=p(s.sha,c,n.length,"/"===location.pathname||P.PAGINATION_SCHEME.test(location.pathname)),m=n.map(f);a(t).parents("article").append(r),a("#talaria-comment-list-"+s.sha).prepend(m),R(s.sha,t.href)}}function O(){t.eachLimit(a(P.PERMALINK_IDENTIFIER),5,T,function(){})}function S(){var t,e=[],i=!1;a.getJSON(P.GIST_MAPPINGS,function(n){for(var r in n)if(n.hasOwnProperty(r)){t=n[r];var o=a(P.PERMALINK_IDENTIFIER+'[href="'+t.permalink+'"]');i=o.length>0,i&&e.push({gist:n[r],linkobj:o})}A(e)}).fail(function(){var t=p("","",0,!1);a(P.PERMALINK_IDENTIFIER).each(function(){a(this).parents("article").append(t)}),a("div.talaria-wrapper div.talaria-load-error").text("Unable to load comments.").removeClass("hide"),a("div.talaria-wrapper div.talaria-comment-count").addClass("hide")})}function N(t){var e=t.gist,i=l(e.permalink),n=new a.Deferred;return void 0!==i?n.resolve(i):a.getJSON("https://api.github.com/gists/"+e.id+"/comments",function(a){e.comments=a,o(e.permalink,e),n.resolve(e)}).fail(function(a){e.comments=[],n.reject(a,e)}),n.promise()}function g(a,t){N(a).done(function(e){w(a.linkobj,e),t()}).fail(function(e,i){b(a.linkobj,e,i),t()})}function A(a){t.eachLimit(a,5,g,function(a){a&&console.warn("Unable to map comments to articles: "+a)})}function b(t,e,i){var n=P.GIST_URL_ROOT+i.id+"#comments",r=p(i.id,n,i.comments.length,"/"===location.pathname||P.PAGINATION_SCHEME.test(location.pathname));switch(t.parents("article").append(r),e.status){case 403:a("#talaria-wrap-"+i.id+" div.talaria-load-error").text("The github API rate-limit has been reached. Unable to load comments.").removeClass("hide"),a("#talaria-wrap-"+i.id+" div.talaria-comment-count").addClass("hide");break;case 404:a("#talaria-wrap-"+i.id+" div.talaria-load-error").text("Unable to find a matching gist.").removeClass("hide"),a("#talaria-wrap-"+i.id+" div.talaria-comment-count").addClass("hide");break;default:a("#talaria-wrap-"+i.id+" div.talaria-load-error").text("An error occurred retrieving comments for this post.").removeClass("hide"),a("#talaria-wrap-"+i.id+" div.talaria-comment-count").addClass("hide")}}function R(t,e){a("a#talaria-show-"+t).click(function(e){e.preventDefault(),a("div#talaria-wrap-"+t+" .talaria-comment-list-wrapper").fadeIn(),a(this).addClass("hide")}),a("a#talaria-add-"+t).click(function(){P.LOCAL_STORAGE_SUPPORTED&&sessionStorage.removeItem(e)})}function w(t,e){var i=P.GIST_URL_ROOT+e.id+"#comments",n=p(e.id,i,e.comments.length,"/"===location.pathname||P.PAGINATION_SCHEME.test(location.pathname)),r=e.comments.map(f);t.parents("article").append(n),a("#talaria-comment-list-"+e.id).prepend(r),R(e.id,e.permalink)}var P={},M={COMMENTABLE_CONTENT_PATH_PREFIX:"_posts/",CONTENT_SUFFIX:".md",CACHE_TIMEOUT:36e5,PAGINATION_SCHEME:/\/page\d+\//,LOCAL_STORAGE_SUPPORTED:!1,PERMALINK_IDENTIFIER:"a.permalink",PERMALINK_STYLE:/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)$/},C=function(t){h(t),u(),a(document).ready(function(){r&&(P.LOCAL_STORAGE_SUPPORTED=!0),a.ajaxSetup({accepts:{json:"application/vnd.github.v3.html+json"}}),P.USE_GISTS?S():O()})};return{init:C,test:{init:function(a){h(a)},gists:S,commits:O}}}($,async);