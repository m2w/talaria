var talaria=function(t,a){"use strict";function e(t){this.name="RateLimitedError",this.message=t||"Rate-Limit exceeded."}function r(t){this.name="NotFoundError",this.message=t||"Object not found."}function n(t){return 403===t.status}var i={},o={COMMENTABLE_CONTENT_PATH_PREFIX:"_posts/",CONTENT_SUFFIX:".md",CACHE_TIMEOUT:36e5,PAGINATION_SCHEME:/\/page\d+\//,LOCAL_STORAGE_SUPPORTED:!1,PERMALINK_IDENTIFIER:"a.permalink",PERMALINK_STYLE:/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)$/},c=function(){switch(i.PERMALINK_STYLE){case"pretty":return/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)\/$/;case"date":return/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)\.html$/;case"none":if(!i.USE_GISTS)throw new Error("When using commit-based comments, talaria requires the use of permalinks that include the date of the post");return/[\.\w\-_:\/]+\/([\w\-\.]+)\.html$/;default:return i.PERMALINK_STYLE}},s=function(t){return t.replace(i.PERMALINK_STYLE,i.COMMENTABLE_CONTENT_PATH_PREFIX+"$1-$2-$3-$4"+i.CONTENT_SUFFIX)},m=function(t){return t.substr(0,7)},d=function(){try{return sessionStorage.setItem("dummy","dummy"),sessionStorage.removeItem("dummy"),!0}catch(t){return!1}},l=function(t){return(new Date).getTime()-t.timestamp>i.CACHE_TIMEOUT},u=function(t){var e;return i.LOCAL_STORAGE_SUPPORTED&&(e=sessionStorage.getItem(t),e&&(e=JSON.parse(e),!l(e)))?a.resolve(e.commentData):a.reject("cache miss")},h=function(t,a){i.LOCAL_STORAGE_SUPPORTED&&sessionStorage.setItem(t,JSON.stringify({timestamp:(new Date).getTime(),commentData:a}))},p=function(t){return t.length>0?t.sort(function(t,a){return new Date(t.commit.committer.date)>new Date(a.commit.committer.date)})[0]:void 0},f=function(t,a){var e=function(t){return 1===t?"":"s"},r=6e4,n=60*r,i=24*n,o=30*i,c=365*i,s=15e3,m=t-a,d=0;return r>m?s>m?" just now":Math.round(m/1e3)+" seconds ago":n>m?(d=Math.round(m/r),d+" minute"+e(d)+" ago"):i>m?(d=Math.round(m/n),d+" hour"+e(d)+" ago"):o>m?(d=Math.round(m/i),d+" day"+e(d)+" ago"):c>m?(d=Math.round(m/o),"about "+d+" month"+e(d)+" ago"):(d=Math.round(m/c),"about "+d+" year"+e(d)+" ago")},v=function(a,e,r){t("a#talaria-show-"+a).click(function(e){r&&(e.preventDefault(),t("div#talaria-wrap-"+a+" .talaria-comment-list-wrapper").fadeIn(),t(this).addClass("hide"))}),t("a#talaria-add-"+a).click(function(){i.LOCAL_STORAGE_SUPPORTED&&sessionStorage.removeItem(e)})};e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,r.prototype=Object.create(Error.prototype),r.prototype.constructor=r;var E=function(t,a,e,r){return r=0===e||r,'<div id="talaria-wrap-'+t+'" class="talaria-wrapper">  <div class="talaria-load-error hide">    Unable to retrieve comments for this post.  </div>  <div class="talaria-comment-count'+(r?"":" hide")+'">    <a id="talaria-show-'+t+'" href="'+a+'">'+(0===e?"Be the first to comment":e+" comment"+(1===e?"":"s"))+'</a>  </div>  <div class="talaria-comment-list-wrapper'+(r?" hide":"")+'">    <div class="talaria-header">      <h3>Comments <small>via <a class="talaria-last-commit-href" href="'+a+'">github</a></small></h3>    </div>    <div class="talaria-comment-list" id="talaria-comment-list-'+t+'">      <!-- comments are dynamically added here -->    </div>    <div class="talaria-align-right">      <a id="talaria-add-'+t+'" class="talaria-add-comment-button" href="'+a+'">        <button type="submit">Add a Comment</button>      </a>    </div>  </div></div>'},_=function(t){var a,e=(new Date).getTime();return a=void 0!==t.commit_id?'<span class="talaria-header-left">&nbsp;commented on <a class="talaria-commit-sha" href="'+t.html_url+'"><code>'+m(t.commit_id)+"</code></a></span>":'<span class="talaria-header-left">&nbsp;wrote</span>','<div id="'+t.id+'" class="talaria-comment-bubble">  <a class="talaria-author-nick" href="'+t.user.html_url+'">    <img class="talaria-comment-author-avatar" height="48" width="48" src="'+t.user.avatar_url+'" />  </a>  <div class="talaria-comment-bubble-content">    <div class="talaria-comment-bubble-inner">      <div class="talaria-comment-header">        <a class="talaria-author-nick" href="'+t.user.html_url+'"><b>'+t.user.login+"</b></a>"+a+'        <span class="talaria-header-right">'+f(e,new Date(t.updated_at))+'</span>      </div>      <div class="talaria-comment-body">'+t.body_html||t.body+"</div>    </div>  </div></div>"},T=function(){return I().map(function(a){var n=a;return u(n.url).then(function(t){return N(n,cacheData),t}).catch(function(){return O(a).reduce(function(t,a){return g(a).then(function(e){return t.comments=t.comments.concat(e),t.commits.push({sha:a.sha,commit:{committer:{date:a.commit.committer.date}}}),t})},{comments:[],commits:[]}).then(function(t){var a={comments:t.comments,commits:t.commits};return h(n.url,a),N(n,a),t.comments}).catch(e,function(){var a=t(n).parents("article"),e=E("","",0,!1);a.append(e),a.find("div.talaria-load-error").text("The Github API rate-limit has been reached. Unable to load comments.").removeClass("hide"),a.find("div.talaria-comment-count").addClass("hide")}).catch(r,function(){var a=t(n).parents("article"),e=E("","",0,!1);a.append(e),a.find("div.talaria-load-error").text("Unable to find commits for this post.").removeClass("hide"),a.find("div.talaria-comment-count").addClass("hide")})})},{concurrency:2})},I=function(){var e=[];return t(i.PERMALINK_IDENTIFIER).each(function(t,a){e.push(a)}),a.resolve(e)},O=function(o){var c=s(o.href);return a.resolve(t.getJSON(i.COMMIT_API_ENDPOINT,{path:c})).then(function(t){if(0===t.length)throw new r;return a.resolve(t)}).catch(n,function(){throw new e})},g=function(r){return r.commit.comment_count>0?a.resolve(t.getJSON(i.COMMIT_API_ENDPOINT+"/"+r.sha+"/comments")).then(function(t){return t}).catch(n,function(){throw new e}).catch(function(){return[]}):[]},N=function(a,e){var r=e.comments,n=p(e.commits),o=i.REPO_COMMIT_URL_ROOT+n.sha+"#all_commit_comments",c=E(n.sha,o,r.length,"/"===location.pathname||i.PAGINATION_SCHEME.test(location.pathname)),s=r.map(_);t(a).parents("article").append(c),t("#talaria-comment-list-"+n.sha).prepend(s),v(n.sha,a.href,r.length>0)},S=function(){return a.resolve(t.getJSON(i.GIST_MAPPINGS)).then(function(t){return A(t)}).map(function(t){var a=t.gist;return u(a.permalink).catch(function(){return b(a)}).then(function(a){return w(t.linkobj,a),a}).catch(function(e){return a.comments=[],P(t.linkobj,e,a),a})},{concurrency:2}).catch(function(){return R(),[]})},b=function(e){return a.resolve(t.getJSON("https://api.github.com/gists/"+e.id+"/comments")).then(function(t){return e.comments=t,h(e.permalink,e),e})},A=function(a){var e,r=[],n=!1;for(var o in a)if(a.hasOwnProperty(o)){e=a[o];var c=t(i.PERMALINK_IDENTIFIER+'[href="'+e.permalink+'"]');n=c.length>0,n&&r.push({gist:a[o],linkobj:c})}return r},R=function(){var a=E("","",0,!1);t(i.PERMALINK_IDENTIFIER).each(function(){t(this).parents("article").append(a)}),t("div.talaria-wrapper div.talaria-load-error").text("Unable to load comments.").removeClass("hide"),t("div.talaria-wrapper div.talaria-comment-count").addClass("hide")},P=function(a,e,r){var n=i.GIST_URL_ROOT+r.id+"#comments",o=E(r.id,n,r.comments.length,"/"===location.pathname||i.PAGINATION_SCHEME.test(location.pathname));switch(a.parents("article").append(o),e.status){case 403:t("#talaria-wrap-"+r.id+" div.talaria-load-error").text("The Github API rate-limit has been reached. Unable to load comments.").removeClass("hide"),t("#talaria-wrap-"+r.id+" div.talaria-comment-count").addClass("hide");break;case 404:t("#talaria-wrap-"+r.id+" div.talaria-load-error").text("Unable to find a matching gist.").removeClass("hide"),t("#talaria-wrap-"+r.id+" div.talaria-comment-count").addClass("hide");break;default:t("#talaria-wrap-"+r.id+" div.talaria-load-error").text("An error occurred retrieving comments for this post.").removeClass("hide"),t("#talaria-wrap-"+r.id+" div.talaria-comment-count").addClass("hide")}},w=function(a,e){var r=i.GIST_URL_ROOT+e.id+"#comments",n=E(e.id,r,e.comments.length,"/"===location.pathname||i.PAGINATION_SCHEME.test(location.pathname)),o=e.comments.map(_);a.parents("article").append(n),t("#talaria-comment-list-"+e.id).prepend(o),v(e.id,e.permalink,e.comments.length>0)},M=function(a){i=t.extend({},o,a),i.GISTS_API_ENDPOINT="https://api.github.com/users/"+i.GITHUB_USERNAME+"/gists",i.COMMIT_API_ENDPOINT="https://api.github.com/repos/"+i.GITHUB_USERNAME+"/"+i.REPOSITORY_NAME+"/commits",i.REPO_COMMIT_URL_ROOT="https://github.com/"+i.GITHUB_USERNAME+"/"+i.REPOSITORY_NAME+"/commit/",i.GIST_URL_ROOT="https://gist.github.com/"+i.GITHUB_USERNAME+"/",i.PERMALINK_STYLE=c()},C=function(a){return M(a),d&&(i.LOCAL_STORAGE_SUPPORTED=!0),t.ajaxSetup({accepts:{json:"application/vnd.github.v3.html+json"}}),i.USE_GISTS?S():T()};return{init:C}}($,P);