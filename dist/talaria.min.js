var talaria=function(t,a){"use strict";function e(){switch(M.PERMALINK_STYLE){case"pretty":return/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)\/$/;case"date":return/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)\.html$/;case"none":if(!M.USE_GISTS)throw new Error("When using commit-based comments, talaria requires the use of permalinks that include the date of the post");return/[\.\w\-_:\/]+\/([\w\-\.]+)\.html$/;default:return M.PERMALINK_STYLE}}function i(t){return t.replace(M.PERMALINK_STYLE,M.COMMENTABLE_CONTENT_PATH_PREFIX+"$1-$2-$3-$4"+M.CONTENT_SUFFIX)}function n(t){return t.substr(0,7)}function r(){try{return sessionStorage.setItem("dummy","dummy"),sessionStorage.removeItem("dummy"),!0}catch(t){return!1}}function o(t,a){M.LOCAL_STORAGE_SUPPORTED&&sessionStorage.setItem(t,JSON.stringify({timestamp:(new Date).getTime(),commentData:a}))}function s(t,a){return new Date(t.updated_at)>new Date(a.updated_at)}function c(t,a){function e(t){return 1===t?"":"s"}var i=6e4,n=60*i,r=24*n,o=30*r,s=365*r,c=15e3,m=t-a,l=0;return i>m?c>m?" just now":Math.round(m/1e3)+" seconds ago":n>m?(l=Math.round(m/i),l+" minute"+e(l)+" ago"):r>m?(l=Math.round(m/n),l+" hour"+e(l)+" ago"):o>m?(l=Math.round(m/r),l+" day"+e(l)+" ago"):s>m?(l=Math.round(m/o),"about "+l+" month"+e(l)+" ago"):(l=Math.round(m/s),"about "+l+" year"+e(l)+" ago")}function m(t){return(new Date).getTime()-t.timestamp>M.CACHE_TIMEOUT}function l(t){var a;return M.LOCAL_STORAGE_SUPPORTED&&(a=sessionStorage.getItem(t),a&&(a=JSON.parse(a),!m(a)))?a.commentData:void 0}function d(t){return t.length>0?t.sort(function(t,a){return new Date(t.committer.date)>new Date(a.committer.date)})[0]:void 0}function u(t){return t.map(function(t){return{sha:t.sha,committer:{date:t.committer.date}}})}function h(){if(M.USE_GISTS&&a==={})throw new Error("talaria requires async.js for Gist-based comments.")}function f(a){M=t.extend({},C,a),M.GISTS_API_ENDPOINT="https://api.github.com/users/"+M.GITHUB_USERNAME+"/gists",M.COMMIT_API_ENDPOINT="https://api.github.com/repos/"+M.GITHUB_USERNAME+"/"+M.REPOSITORY_NAME+"/commits",M.REPO_COMMIT_URL_ROOT="https://github.com/"+M.GITHUB_USERNAME+"/"+M.REPOSITORY_NAME+"/commit/",M.GIST_URL_ROOT="https://gist.github.com/"+M.GITHUB_USERNAME+"/",M.PERMALINK_STYLE=e()}function p(t,a,e,i){return i=0===e||i,'<div id="talaria-wrap-'+t+'" class="talaria-wrapper">  <div class="talaria-load-error hide">    Unable to retrieve comments for this post.  </div>  <div class="talaria-comment-count'+(i?"":" hide")+'">    <a id="talaria-show-'+t+'" href="'+a+'">'+(0===e?"Be the first to comment":e+" comment"+(1===e?"":"s"))+'</a>  </div>  <div class="talaria-comment-list-wrapper'+(i?" hide":"")+'">    <div class="talaria-header">      <h3>Comments <small>via <a class="talaria-last-commit-href" href="'+a+'">github</a></small></h3>    </div>    <div class="talaria-comment-list" id="talaria-comment-list-'+t+'">      <!-- comments are dynamically added here -->    </div>    <div class="talaria-align-right">      <a id="talaria-add-'+t+'" class="talaria-add-comment-button" href="'+a+'">        <button type="submit">Add a Comment</button>      </a>    </div>  </div></div>'}function _(t){var a,e=(new Date).getTime();return a=void 0!==t.commit_id?'<span class="talaria-header-left">&nbsp;commented on <a class="talaria-commit-sha" href="'+t.html_url+'"><code>'+n(t.commit_id)+"</code></a></span>":'<span class="talaria-header-left">&nbsp;wrote</span>','<div id="'+t.id+'" class="talaria-comment-bubble">  <a class="talaria-author-nick" href="'+t.user.html_url+'">    <img class="talaria-comment-author-avatar" height="48" width="48" src="'+t.user.avatar_url+'" />  </a>  <div class="talaria-comment-bubble-content">    <div class="talaria-comment-bubble-inner">      <div class="talaria-comment-header">        <a class="talaria-author-nick" href="'+t.user.html_url+'"><b>'+t.user.login+"</b></a>"+a+'        <span class="talaria-header-right">'+c(e,new Date(t.updated_at))+'</span>      </div>      <div class="talaria-comment-body">'+t.body_html||t.body+"</div>    </div>  </div></div>"}function E(a,e){t.getJSON(M.COMMIT_API_ENDPOINT,{path:a}).then(function(t){e(null,t)},function(t){e(t)})}function v(a,e,i){e.commit.comment_count>0?t.getJSON(M.COMMIT_API_ENDPOINT+"/"+e.sha+"/comments").then(function(t){i(null,a.concat(t))},function(t){i(t,a)}):i(null,a)}function T(t,e){a.reduce(t,[],v,function(a,i){i.sort(s),e(a,t,i)})}function I(t,e){var n=t.href,r=i(n),s=l(n);void 0===s?a.waterfall([function(t){E(r,t)},function(t,a){T(t,a)}],function(a,i,r){if(a)e(a);else{var s={comments:r,commits:u(i)};o(n,s),O(t,s),e(null)}}):(O(t,s),e(null))}function O(a,e){var i,n=e.commits,r=e.comments,o=t(a).parents("article");if(0===n.length)i=p("","",0,!1),o.append(i),o.find("div.talaria-load-error").text("Unable to find commits for this post.").removeClass("hide"),o.find("div.talaria-comment-count").addClass("hide");else{var s=d(n),c=M.REPO_COMMIT_URL_ROOT+s.sha+"#all_commit_comments",m=r.map(_);i=p(s.sha,c,r.length,"/"===location.pathname||M.PAGINATION_SCHEME.test(location.pathname)),o.append(i),t("#talaria-comment-list-"+s.sha).prepend(m),w(s.sha,a.href,r.length>0)}}function S(){a.eachLimit(t(M.PERMALINK_IDENTIFIER),5,I,function(){})}function g(){var a,e=[],i=!1;t.getJSON(M.GIST_MAPPINGS,function(n){for(var r in n)if(n.hasOwnProperty(r)){a=n[r];var o=t(M.PERMALINK_IDENTIFIER+'[href="'+a.permalink+'"]');i=o.length>0,i&&e.push({gist:n[r],linkobj:o})}b(e)}).fail(function(){var a=p("","",0,!1);t(M.PERMALINK_IDENTIFIER).each(function(){t(this).parents("article").append(a)}),t("div.talaria-wrapper div.talaria-load-error").text("Unable to load comments.").removeClass("hide"),t("div.talaria-wrapper div.talaria-comment-count").addClass("hide")})}function N(a){var e=a.gist,i=l(e.permalink),n=new t.Deferred;return void 0!==i?n.resolve(i):t.getJSON("https://api.github.com/gists/"+e.id+"/comments",function(t){e.comments=t,o(e.permalink,e),n.resolve(e)}).fail(function(t){e.comments=[],n.reject(t,e)}),n.promise()}function A(t,a){N(t).done(function(e){P(t.linkobj,e),a()}).fail(function(e,i){R(t.linkobj,e,i),a()})}function b(t){a.eachLimit(t,5,A,function(t){t&&console.warn("Unable to map comments to articles: "+t)})}function R(a,e,i){var n=M.GIST_URL_ROOT+i.id+"#comments",r=p(i.id,n,i.comments.length,"/"===location.pathname||M.PAGINATION_SCHEME.test(location.pathname));switch(a.parents("article").append(r),e.status){case 403:t("#talaria-wrap-"+i.id+" div.talaria-load-error").text("The github API rate-limit has been reached. Unable to load comments.").removeClass("hide"),t("#talaria-wrap-"+i.id+" div.talaria-comment-count").addClass("hide");break;case 404:t("#talaria-wrap-"+i.id+" div.talaria-load-error").text("Unable to find a matching gist.").removeClass("hide"),t("#talaria-wrap-"+i.id+" div.talaria-comment-count").addClass("hide");break;default:t("#talaria-wrap-"+i.id+" div.talaria-load-error").text("An error occurred retrieving comments for this post.").removeClass("hide"),t("#talaria-wrap-"+i.id+" div.talaria-comment-count").addClass("hide")}}function w(a,e,i){t("a#talaria-show-"+a).click(function(e){i&&(e.preventDefault(),t("div#talaria-wrap-"+a+" .talaria-comment-list-wrapper").fadeIn(),t(this).addClass("hide"))}),t("a#talaria-add-"+a).click(function(){M.LOCAL_STORAGE_SUPPORTED&&sessionStorage.removeItem(e)})}function P(a,e){var i=M.GIST_URL_ROOT+e.id+"#comments",n=p(e.id,i,e.comments.length,"/"===location.pathname||M.PAGINATION_SCHEME.test(location.pathname)),r=e.comments.map(_);a.parents("article").append(n),t("#talaria-comment-list-"+e.id).prepend(r),w(e.id,e.permalink,e.comments.length>0)}var M={},C={COMMENTABLE_CONTENT_PATH_PREFIX:"_posts/",CONTENT_SUFFIX:".md",CACHE_TIMEOUT:36e5,PAGINATION_SCHEME:/\/page\d+\//,LOCAL_STORAGE_SUPPORTED:!1,PERMALINK_IDENTIFIER:"a.permalink",PERMALINK_STYLE:/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)$/},L=function(a){f(a),h(),t(document).ready(function(){r&&(M.LOCAL_STORAGE_SUPPORTED=!0),t.ajaxSetup({accepts:{json:"application/vnd.github.v3.html+json"}}),M.USE_GISTS?g():S()})};return{init:L,test:{init:function(t){f(t)},gists:g,commits:S}}}($,async);