var talaria=function(t){"use strict";function e(t){return t.replace(/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-_\.]+)$/,l.COMMENTABLE_CONTENT_PATH_PREFIX+"$1-$2-$3-$4"+l.CONTENT_SUFFIX)}function a(t){return t.substr(0,7)}function n(){try{return sessionStorage.setItem("dummy","dummy"),sessionStorage.removeItem("dummy"),!0}catch(t){return!1}}function r(t,e){return new Date(t.updated_at)>new Date(e.updated_at)}function i(t,e){function a(t){return 1===t?"":"s"}var n=6e4,r=60*n,i=24*r,o=30*i,m=365*i,c=15e3,s=t-e,u=0;return n>s?c>s?" just now":Math.round(s/1e3)+" seconds ago":r>s?(u=Math.round(s/n),u+" minute"+a(u)+" ago"):i>s?(u=Math.round(s/r),u+" hour"+a(u)+" ago"):o>s?(u=Math.round(s/i),u+" day"+a(u)+" ago"):m>s?(u=Math.round(s/o),"about "+u+" month"+a(u)+" ago"):(u=Math.round(s/m),"about "+u+" year"+a(u)+" ago")}function o(t){return(new Date).getTime()-t.timestamp>l.CACHE_TIMEOUT}function m(t){var e=sessionStorage.getItem(t);return e&&(e=JSON.parse(e),!o(e))?e.comment_data:void 0}function c(e,a){var n=new t.Deferred;return t.getJSON(l.COMMIT_API_ENDPOINT+"/"+e.sha+"/comments").then(function(t){n.resolve({commits:e,comments:t,path:a})},function(t){n.reject(t.status)}),n}function s(e,a){var n=new t.Deferred,r=a.map(function(t){return c(t,e)});return t.when.apply(t,r).done(function(){var t,a=Array.prototype.slice.call(arguments,0);a&&a.length&&(t={path:e,commits:[],comments:[]},a=a.reduce(function(t,e){return t.commits=t.commits.concat(e.commits),t.comments=t.comments.concat(e.comments),t},t)),n.resolve(a)}),n}function u(e){var a=new t.Deferred;return t.getJSON(l.COMMIT_API_ENDPOINT,{path:e}).then(function(t){s(e,t).done(function(t){a.resolve(t)})},function(t){a.reject(t.status)}),a}function d(a){var n,r=e(a);if(l.LOCAL_STORAGE_SUPPORTED){if(n=m(a)){var i=new t.Deferred;return i.resolve(n),i}return u(r)}return u(r)}function f(e){var n=(new Date).getTime(),r=t("#talaria-comment-placeholder").clone(),o=r.find("div.talaria-comment-header");return r.find("span.talaria-img-placeholder").replaceWith('<img class="talaria-comment-author-avatar" height="48" width="48" src="'+e.user.avatar_url+'" />'),o.find("b").text(e.user.login),o.find("a.talaria-author-nick").attr("href",e.user.html_url),o.find("a.talaria-commit-sha").attr("href",e.html_url).html("<code>"+a(e.commit_id)+"</code>"),o.find("span.talaria-header-right").text(i(n,new Date(e.updated_at))),r.find("div.talaria-comment-body").html(e.body_html),r.attr("id",e.id).show(),r}function h(e,a){var n,r,i,o,m=e.parents("article").find("div.talaria-wrapper");n=a.commits.length?a.commits.sort(function(t,e){return new Date(t.commit.author.date)<new Date(e.commit.author.date)})[0]:a.commits,r=l.REPO_COMMIT_URL_ROOT+n.sha+"#all_commit_comments",m.find("a.talaria-last-commit-href").attr("href",r),a.comments.length>0?"/"===location.pathname||l.PAGINATION_SCHEME.test(location.pathname)?(i=a.comments.length,o=i+" comment"+(1!==i?"s":""),m.find("a.talaria-expand-comments").attr("href",r).click(function(e){e.preventDefault(),m.find("div.talaria-comment-list-wrapper").fadeIn(),t(this).hide()}).text(o)):(m.find("div.talaria-comment-count").hide(),m.find("div.talaria-comment-list-wrapper").fadeIn()):m.find("a.talaria-expand-comments").attr("href",r).text("Be the first to comment"),m.find("a.talaria-add-comment-button").attr("href",r).click(function(){l.LOCAL_STORAGE_SUPPORTED&&sessionStorage.removeItem(e.get(0).href)})}var l={},_={COMMENTABLE_CONTENT_PATH_PREFIX:"_posts/",CONTENT_SUFFIX:".md",CACHE_TIMEOUT:36e5,PAGINATION_SCHEME:/\/page\d+\//,LOCAL_STORAGE_SUPPORTED:!1,PERMALINK_IDENTIFIER:"a.permalink"},p=function(e){l=t.extend({},_,e),l.COMMIT_API_ENDPOINT="https://api.github.com/repos/"+l.GITHUB_USERNAME+"/"+l.REPOSITORY_NAME+"/commits",l.REPO_COMMIT_URL_ROOT="https://github.com/"+l.GITHUB_USERNAME+"/"+l.REPOSITORY_NAME+"/commit/",t(document).ready(function(){n&&(l.LOCAL_STORAGE_SUPPORTED=!0),t.ajaxSetup({accepts:{json:"application/vnd.github.v3.html+json"}}),t(l.PERMALINK_IDENTIFIER).map(function(){var e=this;t.when(d(e.href)).then(function(a){if(t.isEmptyObject(a)){var n=t(e).parents("article");n.find("div.talaria-load-error").show(),n.find("div.talaria-comment-count").hide()}else{var i=a.comments.sort(r).map(f);h(t(e),a),t(e).parents("article").find("div.talaria-comment-list").prepend(i),l.LOCAL_STORAGE_SUPPORTED&&sessionStorage.setItem(e.href,JSON.stringify({timestamp:(new Date).getTime(),comment_data:a}))}},function(){var a=t(e).parents("article");a.find("div.talaria-load-error").text("You have exceeded the github API request limit. Could not retrieve the comments.").show(),a.find("div.talaria-comment-count").hide()})})})},E=function(e){t.get(e)};return{init:p,ping:E}}($);