var talaria=function(a,t){"use strict";function e(){switch(b.PERMALINK_STYLE){case"pretty":return/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)\/$/;case"date":return/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)\.html$/;case"none":if(!b.USE_GISTS)throw new Error("When using commit-based comments, talaria requires the use of permalinks that include the date of the post");return/[\.\w\-_:\/]+\/([\w\-\.]+)\.html$/;default:return b.PERMALINK_STYLE}}function i(a){return a.replace(b.PERMALINK_STYLE,b.COMMENTABLE_CONTENT_PATH_PREFIX+"$1-$2-$3-$4"+b.CONTENT_SUFFIX)}function n(a){return a.substr(0,7)}function r(){try{return sessionStorage.setItem("dummy","dummy"),sessionStorage.removeItem("dummy"),!0}catch(a){return!1}}function o(a,t){b.LOCAL_STORAGE_SUPPORTED&&sessionStorage.setItem(a,JSON.stringify({timestamp:(new Date).getTime(),commentData:t}))}function s(a,t){function e(a){return 1===a?"":"s"}var i=6e4,n=60*i,r=24*n,o=30*r,s=365*r,c=15e3,m=a-t,l=0;return i>m?c>m?" just now":Math.round(m/1e3)+" seconds ago":n>m?(l=Math.round(m/i),l+" minute"+e(l)+" ago"):r>m?(l=Math.round(m/n),l+" hour"+e(l)+" ago"):o>m?(l=Math.round(m/r),l+" day"+e(l)+" ago"):s>m?(l=Math.round(m/o),"about "+l+" month"+e(l)+" ago"):(l=Math.round(m/s),"about "+l+" year"+e(l)+" ago")}function c(a){return(new Date).getTime()-a.timestamp>b.CACHE_TIMEOUT}function m(a){var t;return b.LOCAL_STORAGE_SUPPORTED&&(t=sessionStorage.getItem(a),t&&(t=JSON.parse(t),!c(t)))?t.commentData:void 0}function l(a){return a.length>0?a.sort(function(a,t){return new Date(a.committer.date)>new Date(t.committer.date)})[0]:void 0}function d(){if(b.USE_GISTS&&t==={})throw new Error("talaria requires async.js for Gist-based comments.")}function u(t){b=a.extend({},P,t),b.GISTS_API_ENDPOINT="https://api.github.com/users/"+b.GITHUB_USERNAME+"/gists",b.COMMIT_API_ENDPOINT="https://api.github.com/repos/"+b.GITHUB_USERNAME+"/"+b.REPOSITORY_NAME+"/commits",b.REPO_COMMIT_URL_ROOT="https://github.com/"+b.GITHUB_USERNAME+"/"+b.REPOSITORY_NAME+"/commit/",b.GIST_URL_ROOT="https://gist.github.com/"+b.GITHUB_USERNAME+"/",b.PERMALINK_STYLE=e()}function h(a,t,e,i){return i=0===e||i,'<div id="talaria-wrap-'+a+'" class="talaria-wrapper">  <div class="talaria-load-error hide">    Unable to retrieve comments for this post.  </div>  <div class="talaria-comment-count'+(i?"":" hide")+'">    <a id="talaria-show-'+a+'" href="'+t+'">'+(0===e?"Be the first to comment":e+" comment"+(1===e?"":"s"))+'</a>  </div>  <div class="talaria-comment-list-wrapper'+(i?" hide":"")+'">    <div class="talaria-header">      <h3>Comments <small>via <a class="talaria-last-commit-href" href="'+t+'">github</a></small></h3>    </div>    <div class="talaria-comment-list" id="talaria-comment-list-'+a+'">      <!-- comments are dynamically added here -->    </div>    <div class="talaria-align-right">      <a id="talaria-add-'+a+'" class="talaria-add-comment-button" href="'+t+'">        <button type="submit">Add a Comment</button>      </a>    </div>  </div></div>'}function p(a){var t,e=(new Date).getTime();return t=void 0!==a.commit_id?'<span class="talaria-header-left">&nbsp;commented on <a class="talaria-commit-sha" href="'+a.html_url+'"><code>'+n(a.commit_id)+"</code></a></span>":'<span class="talaria-header-left">&nbsp;wrote</span>','<div id="'+a.id+'" class="talaria-comment-bubble">  <a href="#">    <img class="talaria-comment-author-avatar" height="48" width="48" src="'+a.user.avatar_url+'" />  </a>  <div class="talaria-comment-bubble-content">    <div class="talaria-comment-bubble-inner">      <div class="talaria-comment-header">        <a class="talaria-author-nick" href="'+a.user.html_url+'"><b>'+a.user.login+"</b></a>"+t+'        <span class="talaria-header-right">'+s(e,new Date(a.updated_at))+'</span>      </div>      <div class="talaria-comment-body">'+a.body_html||a.body+"</div>    </div>  </div></div>"}function f(t,e){a.getJSON(b.COMMIT_API_ENDPOINT,{path:t}).then(function(a){e(null,a)},function(a){e(a)})}function _(t,e){t.commit.comment_count>0&&a.getJSON(b.COMMIT_API_ENDPOINT+"/"+t.sha+"/comments").then(function(a){e(null,a)},function(a){e(a,[])}),e(null,[])}function E(a,e){t.mapSeries(a,_,function(t,i){e(t,a,[].concat.apply([],i))})}function T(e,n){var r=e.href,s=i(r),c=m(r);void 0===c?t.waterfall([function(a){f(s,a)},function(a,t){E(a,t)}],function(t,i,s){t&&n(t),o(r,s);var c=l(i),m=b.REPO_COMMIT_URL_ROOT+c.sha+"#all_commit_comments",d=h(c.sha,m,s.length,"/"===location.pathname||b.PAGINATION_SCHEME.test(location.pathname)),u=s.map(p);e.parents("article").append(d),a("#talaria-comment-list-"+c.sha).prepend(u),A(c.sha,r),n(null)}):n(null)}function v(){t.eachLimit(a(b.PERMALINK_IDENTIFIER),5,T,function(){})}function I(){var t,e=[],i=!1;a.getJSON(b.GIST_MAPPINGS,function(n){for(var r in n)if(n.hasOwnProperty(r)){t=n[r];var o=a(b.PERMALINK_IDENTIFIER+'[href="'+t.permalink+'"]');i=o.length>0,i&&e.push({gist:n[r],linkobj:o})}N(e)}).fail(function(){var t=h("","",0,!1);a(b.PERMALINK_IDENTIFIER).each(function(){a(this).parents("article").append(t)}),a("div.talaria-wrapper div.talaria-load-error").text("Unable to load comments.").removeClass("hide"),a("div.talaria-wrapper div.talaria-comment-count").addClass("hide")})}function O(t){var e=t.gist,i=m(e.permalink),n=new a.Deferred;return void 0!==i?n.resolve(i):a.getJSON("https://api.github.com/gists/"+e.id+"/comments",function(a){e.comments=a,o(e.permalink,e),n.resolve(e)}).fail(function(a){e.comments=[],n.reject(a,e)}),n.promise()}function S(a,t){O(a).done(function(e){R(a.linkobj,e),t()}).fail(function(e,i){g(a.linkobj,e,i),t()})}function N(a){t.eachLimit(a,5,S,function(a){a&&console.warn("Unable to map comments to articles: "+a)})}function g(t,e,i){var n=b.GIST_URL_ROOT+i.id+"#comments",r=h(i.id,n,i.comments.length,"/"===location.pathname||b.PAGINATION_SCHEME.test(location.pathname));switch(t.parents("article").append(r),e.status){case 403:a("#talaria-wrap-"+i.id+" div.talaria-load-error").text("The github API rate-limit has been reached. Unable to load comments.").removeClass("hide"),a("#talaria-wrap-"+i.id+" div.talaria-comment-count").addClass("hide");break;case 404:a("#talaria-wrap-"+i.id+" div.talaria-load-error").text("Unable to find a matching gist.").removeClass("hide"),a("#talaria-wrap-"+i.id+" div.talaria-comment-count").addClass("hide");break;default:a("#talaria-wrap-"+i.id+" div.talaria-load-error").text("An error occurred retrieving comments for this post.").removeClass("hide"),a("#talaria-wrap-"+i.id+" div.talaria-comment-count").addClass("hide")}}function A(t,e){a("a#talaria-show-"+t).click(function(e){e.preventDefault(),a("div#talaria-wrap-"+t+" .talaria-comment-list-wrapper").fadeIn(),a(this).addClass("hide")}),a("a#talaria-add-"+t).click(function(){b.LOCAL_STORAGE_SUPPORTED&&sessionStorage.removeItem(e)})}function R(t,e){var i=b.GIST_URL_ROOT+e.id+"#comments",n=h(e.id,i,e.comments.length,"/"===location.pathname||b.PAGINATION_SCHEME.test(location.pathname)),r=e.comments.map(p);t.parents("article").append(n),a("#talaria-comment-list-"+e.id).prepend(r),A(e.id,e.permalink)}var b={},P={COMMENTABLE_CONTENT_PATH_PREFIX:"_posts/",CONTENT_SUFFIX:".md",CACHE_TIMEOUT:36e5,PAGINATION_SCHEME:/\/page\d+\//,LOCAL_STORAGE_SUPPORTED:!1,PERMALINK_IDENTIFIER:"a.permalink",PERMALINK_STYLE:/[\.\w\-_:\/]+\/(\d+)\/(\d+)\/(\d+)\/([\w\-\.]+)$/},w=function(t){u(t),d(),a(document).ready(function(){r&&(b.LOCAL_STORAGE_SUPPORTED=!0),a.ajaxSetup({accepts:{json:"application/vnd.github.v3.html+json"}}),b.USE_GISTS?I():v()})};return{init:w,test:{init:function(a){u(a)},gists:I,commits:v}}}($,async);